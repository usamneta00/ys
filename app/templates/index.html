<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yemensoft - Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="static/js/main.js" defer></script>



    <!-- Ù…ÙƒØªØ¨Ø§Øª Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
    <script src="/static/js/jquery-3.7.1.min.js"></script>  
    <script src="/static/js/marked.min.js"></script>
    <script src="/static/js/highlight.js"></script>
    <script src="/static/js/sql.js"></script>
    <script src="static/js/motion-one-dom.min.js"></script>
    <link rel="stylesheet" href="/static/css/highlight/github.css" id="light-theme-highlight">
    <link rel="stylesheet" href="/static/css/highlight/github-dark.css" id="dark-theme-highlight">
    <link rel="stylesheet" href="/static/css/style.css">

    <link rel="icon" type="image/png" href="/static/images/website_top_logo_icon-150x150.png" alt="Logo">
    <link rel="stylesheet" href="/static/css/fontawesome/all.css">


<style>
</style></head><body>
    <div class="app-container">
        <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
        <aside class="sidebar">

            <div class="collapse-btn-group" style="position: absolute;left: 20px;">
                <div style="display: flex; align-items: center;">
                    <div class="vertical-divider"></div>
                    <button class="collapse-btn button-arrow">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <line x1="4" y1="12" x2="20" y2="12"></line>
                            <polyline points="14 6 20 12 14 18"></polyline>
                        </svg>
                    </button>
                </div>

            </div>

            <div class="brand">
                <img src="/static/images/website_top_logo_icon-150x150.png" alt="Onyx Logo" class="logo">
                <div class="separator"></div>
            </div>

            <nav class="nav-links">
                <ul class="menu-list">
                    <li class="menu-item active">
                        <a href="#" class="menu-link">
                            <i class="fas fa-comment"></i>
                            <span>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø°ÙƒÙŠØ©</span>
                        </a>
                    </li>
                    <li class="menu-item disabled">
                        <a href="#" class="menu-link">
                            <div style="display: flex; flex-direction: column; align-items: center;">
                                <i class="fas fa-comments icon" style="font-size: 80px; margin-bottom: 15px;"></i>
                                <span class="text" style="text-align: center;">Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Chat AI ÙŠÙ†Ø´Ø¦ Ù…ÙˆØ§Ø¶ÙŠØ¹ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©. Ø§Ø¨Ø¯Ø£ ÙˆØ§Ø³ØªÙ…ØªØ¹ Ø¨Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¹Ù†Ø¯Ù…Ø§ ØªÙƒÙˆÙ† Ù…Ø³ØªØ¹Ø¯Ù‹Ø§.</p>
                                <span class="pro-badge">Ù‚Ø±ÙŠØ¨Ø§Ù‹</span>
                            </div>
                        </a>
                    </li>
                </ul>
            </nav>



            <!-- Ø²Ø± API -->
            <button class="api-button">
                <i class="fas fa-key"></i>
                ØªØ¹ÙŠÙŠÙ† Ù…ÙØªØ§Ø­ API
            </button>

            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
            <div class="user-panel">
                <div class="user-info">
                    <img src="/static/images/avatar.png" alt="User Avatar" class="avatar">
                    <span class="username">Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ</span>
                </div>
                <div class="user-actions">
                    <button class="settings-btn">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
        <main class="main-content">
             <!-- Ø²Ø± Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ - Ø³ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ -->
            <button class="restore-sidebar">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                 <line x1="9" y1="3" x2="9" y2="21"></line>
                </svg>
            </button>

            <header class="navbar">
                <div class="breadcrumb">
                    <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                    <i class="fas fa-chevron-left"></i>
                    <span>Ù…Ø­Ø§Ø¯Ø«Ø© Ø£ÙˆÙ†ÙƒØ³ Ø§Ù„Ø°ÙƒÙŠØ©</span>
                </div>
                
                <div class="navbar-actions">
                    
                    <button class="api-key-btn">
                        <i class="fas fa-key"></i>
                    </button>
                    
                    <div class="info-btn-container">
                        <button class="info-btn">
                            <i class="fas fa-info-circle"></i>
                        </button>
                        <div class="dropdown-menu info-dropdown">
                            <div class="dropdown-content">
                                <a href="#" class="dropdown-item primary">
                                    Ø³Ø·Ø­  Ù…ÙƒØªØ¨  Onyx AI
                               </a>
                               <a href="#" class="dropdown-item">
                                   Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ (Ù‚Ø±ÙŠØ¨Ø§Ù‹)
                               </a>
                               <a href="#" class="dropdown-item">
                                   ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© (ØªØ­Øª Ø§Ù„ØªØ·ÙˆÙŠØ±)
                               </a>
                            </div>
                        </div>
                    </div>
                    
                    <button class="theme-toggle">
                        <i class="fas fa-moon"></i>
                    </button>
                    
                    <div class="user-menu">
                        <div class="user-avatar">YS</div>
                    </div>
                </div>
            </header>

            <div class="content">
                <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
                <div class="chat-area">
                    <div class="message-list" >
                        <!-- Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø³ØªØ¶Ø§Ù Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                        <div class="image-grid messages-grid" id="messagesGrid">
                            <div class="empty-state">
        
                            </div>
                        </div>
                    </div>
                    
                    <div class="message-input">
                        <textarea placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."></textarea>
                        <button class="send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                        <button class="send-btn voice-button">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© API Modal -->
    <div class="modal" id="apiModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ OpenAI API Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <p class="modal-description">
                    ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù…ÙØªØ§Ø­ OpenAI API Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙŠØ²Ø§Øª Chat AI. 
                    ÙŠØªÙ… ØªØ®Ø²ÙŠÙ† Ù…ÙØªØ§Ø­ API Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ù…ØªØµÙØ­Ùƒ ÙˆÙ„Ø§ ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡ Ø¥Ù„Ù‰ Ø£ÙŠ Ù…ÙƒØ§Ù† Ø¢Ø®Ø±.
                </p>
                <div class="input-group">
                    <input type="text" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxx" class="api-input">
                    <button class="save-api-btn">Ø­ÙØ¸ Ù…ÙØªØ§Ø­ API</button>
                </div>
                <a href="https://platform.openai.com/account/api-keys" class="api-link" target="_blank">
                    Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ API Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù…Ù† Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… OpenAI
                </a>
                
                <div class="help-accordion">
                    <button class="accordion-btn">
                        Ù…ÙØªØ§Ø­ API Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù„Ø§ ÙŠØ¹Ù…Ù„ØŸ
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="accordion-content">
                        <ul>
                            <li>ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù„Ø¯ÙŠÙƒ <a href="https://platform.openai.com/account/">Ø­Ø³Ø§Ø¨ OpenAI</a> ÙˆÙ…ÙØªØ§Ø­ API ØµØ§Ù„Ø­.</li>
                            <li>ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ ÙÙŠ <a href="https://platform.openai.com/account/billing/overview">ØµÙØ­Ø© ÙÙˆØªØ±Ø© OpenAI</a>.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>




                
    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© -->
    <div class="dropdown-menu user-dropdown">
        <div class="dropdown-header">
            ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Adela
        </div>
        <div class="dropdown-content">
            <a href="/settings" class="dropdown-item">
                Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
            </a>
            <a href="#" class="dropdown-item">
                Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø´Ø±Ø© Ø§Ù„Ø¥Ø®Ø¨Ø§Ø±ÙŠØ©
            </a>
            <a href="#" class="dropdown-item danger">
                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
            </a>
        </div>
    </div>
    <!-- Ø£Ø¶Ù Ù‡Ø°Ø§ HTML ÙÙŠ Ù†Ù‡Ø§ÙŠØ© body -->
<div class="progress-bar-container" id="progressBar">
    <div class="progress-bar"></div>
</div>
    <script>
// Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø«ÙŠÙ…
let isDarkMode = localStorage.getItem('darkMode') === 'true';

// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
let isRecording = false;
let mediaRecorder = null;
let audioChunks = [];
let isProcessing = false;
let pressTimer = null;

// ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±
const apiModal = document.getElementById('apiModal');
const apiKeyBtn = document.querySelector('.api-key-btn');
const apiButton = document.querySelector('.api-button');
const closeBtn = document.querySelector('.close-btn');
const saveApiBtn = document.querySelector('.save-api-btn');
const apiInput = document.querySelector('.api-input');
const themeToggle = document.querySelector('.theme-toggle');
const infoBtn = document.querySelector('.info-btn');
const infoDropdown = document.querySelector('.info-dropdown');
const userDropdown = document.querySelector('.user-dropdown');
const accordionBtn = document.querySelector('.accordion-btn');
const accordionContent = document.querySelector('.accordion-content');
const settingsBtn = document.querySelector('.settings-btn');
const logoutBtn = document.querySelector('.logout-btn');
const messageInput = document.querySelector('.message-input textarea');
const sendBtn = document.querySelector('.send-btn');
const messageList = document.querySelector('.message-list');
const messagesGrid = document.getElementById('messagesGrid');
const voiceButton = document.querySelector('.voice-button');

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø®ÙŠØ§Ø±Ø§Øª marked
marked.setOptions({
    gfm: true,
    breaks: true,
    tables: true,
    langPrefix: 'language-',
});

// ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ù…Ø­ÙÙˆØ¸
if (isDarkMode) {
    document.body.classList.add('dark-mode');
    themeToggle.querySelector('i').classList.replace('fa-moon', 'fa-sun');
    document.getElementById('light-theme-highlight').disabled = true;
    document.getElementById('dark-theme-highlight').disabled = false;
}else{
    document.getElementById('light-theme-highlight').disabled = false;
    document.getElementById('dark-theme-highlight').disabled = true;
}   

// Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© API
function openApiModal() {
    apiModal.classList.add('active');
}

function closeApiModal() {
    apiModal.classList.remove('active');
}

// Ø­ÙØ¸ Ù…ÙØªØ§Ø­ API
function saveApiKey() {
    const apiKey = apiInput.value.trim();
    if (apiKey && apiKey.startsWith('sk-')) {
        localStorage.setItem('apiKey', apiKey);
        showToast('ØªÙ… Ø­ÙØ¸ Ù…ÙØªØ§Ø­ API Ø¨Ù†Ø¬Ø§Ø­!', 'success');
        closeApiModal();
    } else {
        showToast('Ù…ÙØªØ§Ø­ API ØºÙŠØ± ØµØ§Ù„Ø­', 'error');
    }
}
// Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø«ÙŠÙ…
function toggleTheme() {
    isDarkMode = !isDarkMode;
    document.body.classList.toggle('dark-mode');
    themeToggle.querySelector('i').classList.toggle('fa-moon');
    themeToggle.querySelector('i').classList.toggle('fa-sun');
    localStorage.setItem('darkMode', isDarkMode);

    // ØªØ­Ø¯ÙŠØ« Ù…Ù„ÙØ§Øª CSS Ù„Ù„Ø«ÙŠÙ…
    const lightThemeLink = document.getElementById('light-theme-highlight');
    const darkThemeLink = document.getElementById('dark-theme-highlight');

    if (isDarkMode) {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ø¯Ø§ÙƒÙ†
        const newDarkLink = darkThemeLink.cloneNode(true);
        darkThemeLink.parentNode.replaceChild(newDarkLink, darkThemeLink);
        newDarkLink.disabled = false;
        lightThemeLink.disabled = true;
    } else {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø«ÙŠÙ… Ø§Ù„ÙØ§ØªØ­ 
        const newLightLink = lightThemeLink.cloneNode(true);
        lightThemeLink.parentNode.replaceChild(newLightLink, lightThemeLink);
        newLightLink.disabled = false;
        darkThemeLink.disabled = true;
    }
}

// Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
function toggleDropdown(dropdown) {
    // Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø§Ù„Ø£Ø®Ø±Ù‰
    document.querySelectorAll('.dropdown-menu').forEach(menu => {
        if (menu !== dropdown) menu.classList.remove('active');
    });
    dropdown.classList.toggle('active');
}

// Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙƒÙˆØ±Ø¯ÙŠÙˆÙ†
function toggleAccordion() {
    accordionContent.classList.toggle('active');
    const icon = accordionBtn.querySelector('i');
    icon.classList.toggle('fa-chevron-up');
    icon.classList.toggle('fa-chevron-down');
}





// Ø¥Ø¸Ù‡Ø§ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
apiKeyBtn.addEventListener('click', openApiModal);
apiButton.addEventListener('click', openApiModal);
closeBtn.addEventListener('click', closeApiModal);
saveApiBtn.addEventListener('click', saveApiKey);
themeToggle.addEventListener('click', toggleTheme);
infoBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    infoDropdown.classList.toggle('active');
});
userDropdown.addEventListener('click', () => toggleDropdown(userDropdown));
accordionBtn.addEventListener('click', toggleAccordion);

sendBtn.addEventListener('click', async function(e) {
    if (messageInput.value.trim() !== '') {
        const inputText = messageInput.value.trim();
        messageInput.value = '';
        messageInput.disabled = true;
        
        try {
            await addMessage(inputText);
        } finally {
            messageInput.disabled = false;
            messageInput.focus();
        }
    }
});

// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
messageInput.addEventListener('keypress', async function(e) {
    if (e.key === 'Enter' && this.value.trim() !== '') {
        const inputText = this.value.trim();
        this.value = '';
        this.disabled = true;
        
        try {
            await addMessage(inputText);
        } finally {
            this.disabled = false;
            this.focus();
        }
    }
});

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
document.addEventListener('click', (e) => {
    if (!e.target.closest('.info-btn-container')) {
        infoDropdown.classList.remove('active');
    }
    if (!e.target.closest('.user-menu') && !e.target.closest('.user-dropdown')) {
        userDropdown.classList.remove('active');
    }
});

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
apiModal.addEventListener('click', (e) => {
    if (e.target === apiModal) {
        closeApiModal();
    }
});

// ØªØ­Ù…ÙŠÙ„ Ù…ÙØªØ§Ø­ API Ø§Ù„Ù…Ø­ÙÙˆØ¸
window.addEventListener('load', () => {
    const savedApiKey = localStorage.getItem('apiKey');
    if (savedApiKey) {
        apiInput.value = savedApiKey;
    }
});

// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
settingsBtn.addEventListener('click', () => {
    showToast('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ø³ÙŠØªÙ… Ø¥Ø·Ù„Ø§Ù‚Ù‡Ø§ Ù‚Ø±ÙŠØ¨Ø§Ù‹', 'warning');
});

logoutBtn.addEventListener('click', () => {
    showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'success');
    // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
});

  // Ø¯Ø§Ø®Ù„ Ø¯Ø§Ù„Ø© processMarkdownResponse
  function processMarkdownResponse(response, sql_query='') {
    const emptyState = messagesGrid.querySelector('.empty-state');
    if (emptyState) {
        emptyState.remove();
    }

    const messageDiv = document.createElement('div');
    messageDiv.className = 'message-bubble system-message markdown-content';

    let markdownText = response;
    if (typeof response === 'string') {
        console.log(markdownText);

        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ SQL Query
        const sqlHtml = sql_query ? `
            <div class="sql-section">
                <button class="sql-toggle-btn">
                    <i class="fas fa-code"></i>
                    <span class="btn-text">Ø¹Ø±Ø¶ SQL Query</span>
                </button>
                <div class="sql-content" style="display: none;">
                    <div class="sql-header">
                        <span>SQL Query</span>
                        <button class="copy-btn">
                            <i class="fas fa-copy"></i>
                            Ù†Ø³Ø®
                        </button>
                    </div>
                    <pre dir="ltr" style="width: fit-content; min-width: min-content; white-space: pre-wrap; word-break: break-word;"><code class="language-sql">${sql_query}</code></pre>
                </div>
            </div>
        ` : '';

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Markdown
        const htmlContent = marked.parse(markdownText, {
            gfm: true,
            breaks: true,
            tables: true,
            pedantic: false,
            sanitize: false,
            smartLists: true,
            smartypants: true
        });


        messageDiv.innerHTML = `
            <div class="message-label">Ø§Ù„Ù†Ø¸Ø§Ù…</div>
            <div class="message-container" style="display: flex; align-items: flex-start; gap: 12px;">
                <div style="flex: 1;">
                    <div class="starfox-cards" id="cards-4qcLSK" style="border-radius: 15px 15px 15px 0; max-width: 80%;">
                        <div class="starfox-card" id="card-y9T5F2" style="border-radius: inherit;">
                            <div class="starfox-card__content" style="padding: 12px 15px;">
                                ${sqlHtml}
                                <p class="starfox-paragraph starfox-paragraph--md" id="paragraph-G1HycM" style="margin: 0;">
                                    ${htmlContent}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
<div class="message-time"></div>
    `;


        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø­Ø¯Ø« Ù„Ù„Ø²Ø±
        const sqlToggleBtn = messageDiv.querySelector('.sql-toggle-btn');
        const sqlContent = messageDiv.querySelector('.sql-content');
        
        if (sqlToggleBtn && sqlContent) {
            sqlToggleBtn.addEventListener('click', function() {
                const isHidden = sqlContent.style.display === 'none';
                sqlContent.style.display = isHidden ? 'block' : 'none';
                this.querySelector('.btn-text').textContent = isHidden ? 'Ø¥Ø®ÙØ§Ø¡ SQL Query' : 'Ø¹Ø±Ø¶ SQL Query';
                this.classList.toggle('active', isHidden);
            });
        }

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø­Ø¯Ø« Ù„Ø²Ø± Ø§Ù„Ù†Ø³Ø®
        const copyButton = messageDiv.querySelector('.copy-btn');
        if (copyButton) {
            copyButton.addEventListener('click', function() {
                copyToClipboard(this);
            });
        }
    }

    messagesGrid.appendChild(messageDiv);
    messageDiv.scrollIntoView({ behavior: 'smooth' });


// ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ„ÙˆÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
const codeBlocks = messageDiv.querySelectorAll('pre code');
codeBlocks.forEach((block) => {
    hljs.highlightElement(block);
});
}


       // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¯Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…
function copyToClipboard(button) {
    const sqlContent = button.closest('.sql-content');
    if (!sqlContent) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.');
        return;
    }
    const codeElement = sqlContent.querySelector('code');
    if (!codeElement) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†ØµØ± Ø§Ù„ÙƒÙˆØ¯.');
        return;
    }
    const sqlCode = codeElement.textContent;

    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(sqlCode).then(() => {
            // ØªØºÙŠÙŠØ± Ø´ÙƒÙ„ Ø§Ù„Ø²Ø± Ù„Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¬Ø§Ø­
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check"></i> ØªÙ… Ø§Ù„Ù†Ø³Ø®';
            button.classList.add('copied');

            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('copied');
            }, 2000);
        }).catch(err => {
            console.error('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®:', err);
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®: ' + err);
            // ØªØºÙŠÙŠØ± Ø´ÙƒÙ„ Ø§Ù„Ø²Ø± Ù„Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø·Ø£
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="fas fa-times"></i> ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®';
            button.classList.add('copy-error');

            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('copy-error');
            }, 2000);
        });
    } else {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù„Ù†Ø³Ø®
        const textarea = document.createElement('textarea');
        textarea.value = sqlCode;
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
            // ØªØºÙŠÙŠØ± Ø´ÙƒÙ„ Ø§Ù„Ø²Ø± Ù„Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¬Ø§Ø­
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check"></i> ØªÙ… Ø§Ù„Ù†Ø³Ø®';
            button.classList.add('copied');

            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('copied');
            }, 2000);
        } catch (err) {
            console.error('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®:', err);
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®: ' + err);
            // ØªØºÙŠÙŠØ± Ø´ÙƒÙ„ Ø§Ù„Ø²Ø± Ù„Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø·Ø£
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="fas fa-times"></i> ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®';
            button.classList.add('copy-error');

            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('copy-error');
            }, 2000);
        }
        document.body.removeChild(textarea);
    }
}
        // ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØª Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© ØªØ­Ø¯ÙŠØ«Ø§Øª Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
        function sendAudio(audioBlob) {
            if (isProcessing) return;
            
            isProcessing = true;
            voiceButton.disabled = true;
            
            const progressBar = document.getElementById('progressBar');
            const progressBarFill = progressBar.querySelector('.progress-bar');
            
            // Ø¹Ø±Ø¶ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… ÙˆØ¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¯Ø±ÙŠØ¬ÙŠ
            progressBar.style.display = 'block';
            progressBarFill.style.width = '0%';
            
            // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¯Ø±ÙŠØ¬ÙŠ Ù„Ù„Ø´Ø±ÙŠØ·
            let progress = 0;
            const progressInterval = setInterval(() => {
                if (progress < 90) {  // Ù†ØªÙˆÙ‚Ù Ø¹Ù†Ø¯ 90% Ø­ØªÙ‰ Ù†Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø¯
                    progress += 1;
                    progressBarFill.style.width = `${progress}%`;
                }
            }, 100);

            const formData = new FormData();
            formData.append('audio', audioBlob, 'recording.mp3');

            fetch('process_audio/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-API-Key': String(localStorage.getItem('apiKey'))
                }
            })
            .then(response => response.json())
            .then(data => {
                // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¯Ø±ÙŠØ¬ÙŠ ÙˆØ¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø´Ø±ÙŠØ·
                clearInterval(progressInterval);
                progressBarFill.style.width = '100%';
                
                if (data.status === 'success') {
                    createMessageElement(data.user);
                    processMarkdownResponse(data.data,data.sql_query);
                } else {
                    processMarkdownResponse(data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ');
                }
                
                // Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                setTimeout(() => {
                    progressBar.style.display = 'none';
                    progressBarFill.style.width = '0%';
                }, 1000);
            })
            .catch(error => {
                clearInterval(progressInterval);
                console.error('Error:', error);
                if (!apiInput.value) {
                    processMarkdownResponse('Ø¹Ø°Ø±Ø§Ù‹ØŒ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ API Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ OpenAI Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©');
                } else {
                processMarkdownResponse('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ');
                }
                progressBar.style.display = 'none';
            })
            .finally(() => {
                isProcessing = false;
                voiceButton.disabled = false;
            });
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ù†ØµÙŠ
        function sendQuery(query) {
            
            const progressBar = document.getElementById('progressBar');
            const progressBarFill = progressBar.querySelector('.progress-bar');
            
            // Ø¹Ø±Ø¶ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… ÙˆØ¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¯Ø±ÙŠØ¬ÙŠ
            progressBar.style.display = 'block';
            progressBarFill.style.width = '0%';
            
            // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¯Ø±ÙŠØ¬ÙŠ Ù„Ù„Ø´Ø±ÙŠØ·
            let progress = 0;
            const progressInterval = setInterval(() => {
                if (progress < 90) {  // Ù†ØªÙˆÙ‚Ù Ø¹Ù†Ø¯ 90% Ø­ØªÙ‰ Ù†Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø¯
                    progress += 1;
                    progressBarFill.style.width = `${progress}%`;
                }
            }, 100);


            $.ajax({
                url: 'process_query/',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ 
                    query: query, 
                    api_key: localStorage.getItem('apiKey') 
                }),
                success: function(response) {
                     // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¯Ø±ÙŠØ¬ÙŠ ÙˆØ¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø´Ø±ÙŠØ·
                clearInterval(progressInterval);
                progressBarFill.style.width = '100%';

                    if (response.status === 'success') {
                        processMarkdownResponse(response.data, response.sql_query);
                    } else {
                        processMarkdownResponse(response.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ');
                    }
                                    // Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                setTimeout(() => {
                    progressBar.style.display = 'none';
                    progressBarFill.style.width = '0%';
                }, 1000);
                },
                error: function(xhr, status, error) {
                    if (!apiInput.value) {
                        processMarkdownResponse('Ø¹Ø°Ø±Ø§Ù‹ØŒ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ API Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ OpenAI Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©');
                    } else {
                        processMarkdownResponse('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ');
                    }
                }
            });
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
        function createMessageElement(text, type = 'user-message', label = 'Ø§Ù„Ø³Ø¤Ø§Ù„') {
            const emptyState = messagesGrid.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message-bubble ${type}`;

            messageDiv.className = `message-bubble ${type}`;

messageDiv.innerHTML = `
        <div class="message-label">${label}</div>
        
        <div class="message-container" style="display: flex; align-items: flex-start; gap: 12px;">
            <div class="user-avatar" style="width: 45px; height: 45px; border-radius: 50%;  display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-user-circle" style="font-size: 28px; "></i>
            </div>
            <div style="flex: 1;">
                <div class="starfox-cards" id="cards-4qcLSK" style="background: transparent; border-radius: 15px 15px 15px 0; max-width: 80%;">
                    <div class="starfox-card" id="card-y9T5F2" style="border-radius: inherit;">
                        <div class="starfox-card__content" style="padding: 12px 15px;">
                            <p class="starfox-paragraph starfox-paragraph--md" id="paragraph-G1HycM" style="margin: 0;">
                                ${text}
                            </p>
                        </div>
                    </div>
                </div>
                <div class="message-time" style="font-size: 12px; color: #666; margin-top: 4px;">
                    ${new Date().toLocaleTimeString()}
                </div>
            </div>
        </div>
`;

            messagesGrid.appendChild(messageDiv);
            messageDiv.scrollIntoView({ behavior: 'smooth' });

}

    
// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© addMessage
async function addMessage(text) {
    try {
        // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        createMessageElement(text, 'user-message', 'Ø§Ù„Ø³Ø¤Ø§Ù„');
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…
        await sendQuery(text);
    } catch (error) {
        console.error('Error in addMessage:', error);
        if (!apiInput.value) {
                processMarkdownResponse('Ø¹Ø°Ø±Ø§Ù‹ØŒ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ API Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ OpenAI Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©');
        } else {
            processMarkdownResponse('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ');
        }
    }
}
        
        // Ø¯Ø§Ù„Ø© Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                isRecording = false;
                mediaRecorder.stop();
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        function toggleRecording() {
            const micIcon = voiceButton.querySelector('i');
            
            if (isProcessing) return;
            
            if (!isRecording) {
                navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        channelCount: 1,
                        sampleRate: 44100,
                        sampleSize: 16
                    } 
                })
                .then(stream => {
                    isRecording = true;
                    voiceButton.style.background = 'linear-gradient(135deg, #c95959 0%, #ff8d8d 100%)';
                    micIcon.style.color = '#fff';

                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                        sendAudio(audioBlob);
                        voiceButton.style.background = 'linear-gradient(135deg, #c95959 0%, #af2929 100%)';
                        micIcon.style.color = '#fff';

                        
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    setTimeout(() => {
                        if (isRecording) {
                            stopRecording();
                        }
                    }, 10000); // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ØªØ³Ø¬ÙŠÙ„ 10 Ø«ÙˆØ§Ù†ÙŠ
                })
                .catch(error => {
                    console.error('Error accessing microphone:', error);
                    processMarkdownResponse('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†');
                    isProcessing = false;
                });
            } else {
                stopRecording();
            }
        }

        // Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø²Ø±
        voiceButton.addEventListener('touchstart', function(e) {
            e.preventDefault();
            if (!isRecording) {
                toggleRecording();
            }
        });

        voiceButton.addEventListener('touchend', function(e) {
            e.preventDefault();
            if (isRecording) {
                stopRecording();
            }
        });

        // Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø£Ø­Ø¯Ø§Ø« Ø²Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        voiceButton.addEventListener('click', toggleRecording);

        voiceButton.addEventListener('mousedown', function(e) {
            pressTimer = setTimeout(() => {
                toggleRecording();
            }, 200);
        });

        voiceButton.addEventListener('mouseup', function(e) {
            clearTimeout(pressTimer);
            if (isRecording) {
                stopRecording();
            }
        });

        voiceButton.addEventListener('mouseleave', function(e) {
            clearTimeout(pressTimer);
            if (isRecording) {
                stopRecording();
            }
        });        
</script>



</body>
</html>