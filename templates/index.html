<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yemensoft - ุงููุณุงุนุฏ ุงูุฐูู</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="static/js/main.js" defer></script>



    <!-- ููุชุจุงุช ุฌุงูุงุณูุฑูุจุช -->
    <script src="/static/js/jquery-3.7.1.min.js"></script>  
    <script src="/static/js/marked.min.js"></script>
    <script src="/static/js/highlight.js"></script>
    <script src="/static/js/sql.js"></script>
    <script src="static/js/motion-one-dom.min.js"></script>
    <link rel="stylesheet" href="/static/css/highlight/github.css" id="light-theme-highlight">
    <link rel="stylesheet" href="/static/css/highlight/github-dark.css" id="dark-theme-highlight">
    <link rel="stylesheet" href="/static/css/style.css">

    <link rel="icon" type="image/png" href="/static/images/website_top_logo_icon-150x150.png" alt="Logo">
    <link rel="stylesheet" href="/static/css/fontawesome/all.css">


<style>
</style></head><body>
    <div class="app-container">
        <!-- ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ -->
        <aside class="sidebar">

            <div class="collapse-btn-group" style="position: absolute;left: 20px;">
                <div style="display: flex; align-items: center;">
                    <div class="vertical-divider"></div>
                    <button class="collapse-btn button-arrow">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <line x1="4" y1="12" x2="20" y2="12"></line>
                            <polyline points="14 6 20 12 14 18"></polyline>
                        </svg>
                    </button>
                </div>

            </div>

            <div class="brand">
                <img src="/static/images/website_top_logo_icon-150x150.png" alt="Onyx Logo" class="logo">
                <div class="separator"></div>
            </div>

            <nav class="nav-links">
                <ul class="menu-list">
                    <li class="menu-item active">
                        <a href="#" class="menu-link">
                            <i class="fas fa-comment"></i>
                            <span>ุงูุฏุฑุฏุดุฉ ุงูุฐููุฉ</span>
                        </a>
                    </li>
                    <li class="menu-item disabled">
                        <a href="#" class="menu-link">
                            <div style="display: flex; flex-direction: column; align-items: center;">
                                <i class="fas fa-comments icon" style="font-size: 80px; margin-bottom: 15px;"></i>
                                <span class="text" style="text-align: center;">ุจุฏุก ูุญุงุฏุซุฉ ูุน Chat AI ููุดุฆ ููุงุถูุน ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ. ุงุจุฏุฃ ูุงุณุชูุชุน ุจุงููุญุงุฏุซุฉ ุนูุฏูุง ุชููู ูุณุชุนุฏูุง.</p>
                                <span class="pro-badge">ูุฑูุจุงู</span>
                            </div>
                        </a>
                    </li>
                </ul>
            </nav>



            <!-- ุฒุฑ API -->
            <button class="api-button">
                <i class="fas fa-key"></i>
                ุชุนููู ููุชุงุญ API
            </button>

            <!-- ูุนูููุงุช ุงููุณุชุฎุฏู -->
            <div class="user-panel">
                <div class="user-info">
                    <img src="/static/images/avatar.png" alt="User Avatar" class="avatar">
                    <span class="username">ูุณุชุฎุฏู ุบูุฑ ูุนุฑูู</span>
                </div>
                <div class="user-actions">
                    <button class="settings-btn">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- ุงููุญุชูู ุงูุฑุฆูุณู -->
        <main class="main-content">
             <!-- ุฒุฑ ุงูุงุณุชุฑุฌุงุน - ุณูุธูุฑ ุนูุฏ ุฅุฎูุงุก ุงูุดุฑูุท ุงูุฌุงูุจู -->
            <button class="restore-sidebar">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                 <line x1="9" y1="3" x2="9" y2="21"></line>
                </svg>
            </button>

            <header class="navbar">
                <div class="breadcrumb">
                    <span>ุงูุฑุฆูุณูุฉ</span>
                    <i class="fas fa-chevron-left"></i>
                    <span>ูุญุงุฏุซุฉ ุฃูููุณ ุงูุฐููุฉ</span>
                </div>
                
                <div class="navbar-actions">
                    
                    <button class="api-key-btn">
                        <i class="fas fa-key"></i>
                    </button>
                    
                    <div class="info-btn-container">
                        <button class="info-btn">
                            <i class="fas fa-info-circle"></i>
                        </button>
                        <div class="dropdown-menu info-dropdown">
                            <div class="dropdown-content">
                                <a href="#" class="dropdown-item primary">
                                    ุณุทุญ  ููุชุจ  Onyx AI
                               </a>
                               <a href="#" class="dropdown-item">
                                   ูุดุงูุฏุฉ ุงููุซุงุฆู (ูุฑูุจุงู)
                               </a>
                               <a href="#" class="dropdown-item">
                                   ุชุฌุฑุจุฉ ุงููุณุฎุฉ ุงููุฌุงููุฉ (ุชุญุช ุงูุชุทููุฑ)
                               </a>
                            </div>
                        </div>
                    </div>
                    
                    <button class="theme-toggle">
                        <i class="fas fa-moon"></i>
                    </button>
                    
                    <div class="user-menu">
                        <div class="user-avatar">YS</div>
                    </div>
                </div>
            </header>

            <div class="content">
                <!-- ููุทูุฉ ุงููุญุงุฏุซุฉ -->
                <div class="chat-area">
                    <div class="message-list" >
                        <!-- ุฑุณุงุฆู ุงููุญุงุฏุซุฉ ุณุชุถุงู ููุง ุฏููุงููููุงู -->
                        <div class="image-grid messages-grid" id="messagesGrid">
                            <div class="empty-state">
        
                            </div>
                        </div>
                    </div>
                    
                    <div class="message-input">
                        <textarea placeholder="ุงูุชุจ ุฑุณุงูุชู ููุง..."></textarea>
                        <button class="send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                        <button class="send-btn voice-button">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ูุงูุฐุฉ API Modal -->
    <div class="modal" id="apiModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ุฃุฏุฎู ููุชุงุญ OpenAI API ุงูุฎุงุต ุจู</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <p class="modal-description">
                    ุชุญุชุงุฌ ุฅูู ููุชุงุญ OpenAI API ูุงุณุชุฎุฏุงู ููุฒุงุช Chat AI. 
                    ูุชู ุชุฎุฒูู ููุชุงุญ API ุงูุฎุงุต ุจู ูุญููุงู ุนูู ูุชุตูุญู ููุง ูุชู ุฅุฑุณุงูู ุฅูู ุฃู ููุงู ุขุฎุฑ.
                </p>
                <div class="input-group">
                    <input type="text" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxx" class="api-input">
                    <button class="save-api-btn">ุญูุธ ููุชุงุญ API</button>
                </div>
                <a href="https://platform.openai.com/account/api-keys" class="api-link" target="_blank">
                    ุงุญุตู ุนูู ููุชุงุญ API ุงูุฎุงุต ุจู ูู ููุญุฉ ุชุญูู OpenAI
                </a>
                
                <div class="help-accordion">
                    <button class="accordion-btn">
                        ููุชุงุญ API ุงูุฎุงุต ุจู ูุง ูุนููุ
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="accordion-content">
                        <ul>
                            <li>ุชุฃูุฏ ูู ุฃู ูุฏูู <a href="https://platform.openai.com/account/">ุญุณุงุจ OpenAI</a> ูููุชุงุญ API ุตุงูุญ.</li>
                            <li>ุชุฃูุฏ ูู ุฅุถุงูุฉ ูุนูููุงุช ุงููุชุฑุฉ ุงูุฎุงุตุฉ ุจู ูู <a href="https://platform.openai.com/account/billing/overview">ุตูุญุฉ ููุชุฑุฉ OpenAI</a>.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>




                
    <!-- ูุงุฆูุฉ ุงููุณุชุฎุฏู ุงูููุณุฏูุฉ -->
    <div class="dropdown-menu user-dropdown">
        <div class="dropdown-header">
            ๐ ูุฑุญุจุงูุ Adela
        </div>
        <div class="dropdown-content">
            <a href="/settings" class="dropdown-item">
                ุฅุนุฏุงุฏุงุช ุงูููู ุงูุดุฎุตู
            </a>
            <a href="#" class="dropdown-item">
                ุฅุนุฏุงุฏุงุช ุงููุดุฑุฉ ุงูุฅุฎุจุงุฑูุฉ
            </a>
            <a href="#" class="dropdown-item danger">
                ุชุณุฌูู ุงูุฎุฑูุฌ
            </a>
        </div>
    </div>
    <!-- ุฃุถู ูุฐุง HTML ูู ููุงูุฉ body -->
<div class="progress-bar-container" id="progressBar">
    <div class="progress-bar"></div>
</div>
    <script>
// ุฅุฏุงุฑุฉ ุญุงูุฉ ุงูุซูู
let isDarkMode = localStorage.getItem('darkMode') === 'true';

// ุชุนุฑูู ุงููุชุบูุฑุงุช ุงูุนุงูุฉ
let isRecording = false;
let mediaRecorder = null;
let audioChunks = [];
let isProcessing = false;
let pressTimer = null;

// ุชุญุฏูุฏ ุงูุนูุงุตุฑ
const apiModal = document.getElementById('apiModal');
const apiKeyBtn = document.querySelector('.api-key-btn');
const apiButton = document.querySelector('.api-button');
const closeBtn = document.querySelector('.close-btn');
const saveApiBtn = document.querySelector('.save-api-btn');
const apiInput = document.querySelector('.api-input');
const themeToggle = document.querySelector('.theme-toggle');
const infoBtn = document.querySelector('.info-btn');
const infoDropdown = document.querySelector('.info-dropdown');
const userDropdown = document.querySelector('.user-dropdown');
const accordionBtn = document.querySelector('.accordion-btn');
const accordionContent = document.querySelector('.accordion-content');
const settingsBtn = document.querySelector('.settings-btn');
const logoutBtn = document.querySelector('.logout-btn');
const messageInput = document.querySelector('.message-input textarea');
const sendBtn = document.querySelector('.send-btn');
const messageList = document.querySelector('.message-list');
const messagesGrid = document.getElementById('messagesGrid');
const voiceButton = document.querySelector('.voice-button');

// ุฅุนุฏุงุฏ ุฎูุงุฑุงุช marked
marked.setOptions({
    gfm: true,
    breaks: true,
    tables: true,
    langPrefix: 'language-',
});

// ุชุทุจูู ุงูุซูู ุงููุญููุธ
if (isDarkMode) {
    document.body.classList.add('dark-mode');
    themeToggle.querySelector('i').classList.replace('fa-moon', 'fa-sun');
    document.getElementById('light-theme-highlight').disabled = true;
    document.getElementById('dark-theme-highlight').disabled = false;
}else{
    document.getElementById('light-theme-highlight').disabled = false;
    document.getElementById('dark-theme-highlight').disabled = true;
}   

// ุฅุฏุงุฑุฉ ุงูููุงูุฐ ุงูููุจุซูุฉ API
function openApiModal() {
    apiModal.classList.add('active');
}

function closeApiModal() {
    apiModal.classList.remove('active');
}

// ุญูุธ ููุชุงุญ API
function saveApiKey() {
    const apiKey = apiInput.value.trim();
    if (apiKey && apiKey.startsWith('sk-')) {
        localStorage.setItem('apiKey', apiKey);
        showToast('ุชู ุญูุธ ููุชุงุญ API ุจูุฌุงุญ!', 'success');
        closeApiModal();
    } else {
        showToast('ููุชุงุญ API ุบูุฑ ุตุงูุญ', 'error');
    }
}
// ุฅุฏุงุฑุฉ ุงูุซูู
function toggleTheme() {
    isDarkMode = !isDarkMode;
    document.body.classList.toggle('dark-mode');
    themeToggle.querySelector('i').classList.toggle('fa-moon');
    themeToggle.querySelector('i').classList.toggle('fa-sun');
    localStorage.setItem('darkMode', isDarkMode);

    // ุชุญุฏูุซ ูููุงุช CSS ููุซูู
    const lightThemeLink = document.getElementById('light-theme-highlight');
    const darkThemeLink = document.getElementById('dark-theme-highlight');

    if (isDarkMode) {
        // ุฅุนุงุฏุฉ ุชุญููู ููู ุงูุซูู ุงูุฏุงูู
        const newDarkLink = darkThemeLink.cloneNode(true);
        darkThemeLink.parentNode.replaceChild(newDarkLink, darkThemeLink);
        newDarkLink.disabled = false;
        lightThemeLink.disabled = true;
    } else {
        // ุฅุนุงุฏุฉ ุชุญููู ููู ุงูุซูู ุงููุงุชุญ 
        const newLightLink = lightThemeLink.cloneNode(true);
        lightThemeLink.parentNode.replaceChild(newLightLink, lightThemeLink);
        newLightLink.disabled = false;
        darkThemeLink.disabled = true;
    }
}

// ุฅุฏุงุฑุฉ ุงูููุงุฆู ุงูููุณุฏูุฉ
function toggleDropdown(dropdown) {
    // ุฅุบูุงู ุฌููุน ุงูููุงุฆู ุงูููุณุฏูุฉ ุงูุฃุฎุฑู
    document.querySelectorAll('.dropdown-menu').forEach(menu => {
        if (menu !== dropdown) menu.classList.remove('active');
    });
    dropdown.classList.toggle('active');
}

// ุฅุฏุงุฑุฉ ุงูุฃููุฑุฏููู
function toggleAccordion() {
    accordionContent.classList.toggle('active');
    const icon = accordionBtn.querySelector('i');
    icon.classList.toggle('fa-chevron-up');
    icon.classList.toggle('fa-chevron-down');
}





// ุฅุธูุง ุฑุณุงูุฉ ุงูุชูุจูู
function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// ุฅุถุงูุฉ ูุณุชูุนู ุงูุฃุญุฏุงุซ
apiKeyBtn.addEventListener('click', openApiModal);
apiButton.addEventListener('click', openApiModal);
closeBtn.addEventListener('click', closeApiModal);
saveApiBtn.addEventListener('click', saveApiKey);
themeToggle.addEventListener('click', toggleTheme);
infoBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    infoDropdown.classList.toggle('active');
});
userDropdown.addEventListener('click', () => toggleDropdown(userDropdown));
accordionBtn.addEventListener('click', toggleAccordion);

sendBtn.addEventListener('click', async function(e) {
    if (messageInput.value.trim() !== '') {
        const inputText = messageInput.value.trim();
        messageInput.value = '';
        messageInput.disabled = true;
        
        try {
            await addMessage(inputText);
        } finally {
            messageInput.disabled = false;
            messageInput.focus();
        }
    }
});

// ุฅุถุงูุฉ ูุณุชูุนุงุช ุงูุฃุญุฏุงุซ
messageInput.addEventListener('keypress', async function(e) {
    if (e.key === 'Enter' && this.value.trim() !== '') {
        const inputText = this.value.trim();
        this.value = '';
        this.disabled = true;
        
        try {
            await addMessage(inputText);
        } finally {
            this.disabled = false;
            this.focus();
        }
    }
});

// ุฅุบูุงู ุงูููุงุฆู ุงูููุณุฏูุฉ ุนูุฏ ุงูููุฑ ุฎุงุฑุฌูุง
document.addEventListener('click', (e) => {
    if (!e.target.closest('.info-btn-container')) {
        infoDropdown.classList.remove('active');
    }
    if (!e.target.closest('.user-menu') && !e.target.closest('.user-dropdown')) {
        userDropdown.classList.remove('active');
    }
});

// ุฅุบูุงู ุงููุงูุฐุฉ ุงูููุจุซูุฉ ุนูุฏ ุงูููุฑ ุฎุงุฑุฌูุง
apiModal.addEventListener('click', (e) => {
    if (e.target === apiModal) {
        closeApiModal();
    }
});

// ุชุญููู ููุชุงุญ API ุงููุญููุธ
window.addEventListener('load', () => {
    const savedApiKey = localStorage.getItem('apiKey');
    if (savedApiKey) {
        apiInput.value = savedApiKey;
    }
});

// ุฅุถุงูุฉ ูุณุชูุนู ุฃุญุฏุงุซ ููุฃุฒุฑุงุฑ ุงูุฅุถุงููุฉ
settingsBtn.addEventListener('click', () => {
    showToast('ุนุฐุฑุงูุ ูุฐู ุงูููุฒุฉ ุณูุชู ุฅุทูุงููุง ูุฑูุจุงู', 'warning');
});

logoutBtn.addEventListener('click', () => {
    showToast('ุชู ุชุณุฌูู ุงูุฎุฑูุฌ ุจูุฌุงุญ', 'success');
    // ููุง ููููู ุฅุถุงูุฉ ููุทู ุชุณุฌูู ุงูุฎุฑูุฌ
});

  // ุฏุงุฎู ุฏุงูุฉ processMarkdownResponse
  function processMarkdownResponse(response, sql_query='') {
    const emptyState = messagesGrid.querySelector('.empty-state');
    if (emptyState) {
        emptyState.remove();
    }

    const messageDiv = document.createElement('div');
    messageDiv.className = 'message-bubble system-message markdown-content';

    let markdownText = response;
    if (typeof response === 'string') {
        console.log(markdownText);

        // ุฅูุดุงุก ูุญุชูู SQL Query
        const sqlHtml = sql_query ? `
            <div class="sql-section">
                <button class="sql-toggle-btn">
                    <i class="fas fa-code"></i>
                    <span class="btn-text">ุนุฑุถ SQL Query</span>
                </button>
                <div class="sql-content" style="display: none;">
                    <div class="sql-header">
                        <span>SQL Query</span>
                        <button class="copy-btn">
                            <i class="fas fa-copy"></i>
                            ูุณุฎ
                        </button>
                    </div>
                    <pre dir="ltr" style="width: fit-content; min-width: min-content; white-space: pre-wrap; word-break: break-word;"><code class="language-sql">${sql_query}</code></pre>
                </div>
            </div>
        ` : '';

        // ุชุญููู ุงููุต ุฅูู Markdown
        const htmlContent = marked.parse(markdownText, {
            gfm: true,
            breaks: true,
            tables: true,
            pedantic: false,
            sanitize: false,
            smartLists: true,
            smartypants: true
        });


        messageDiv.innerHTML = `
            <div class="message-label">ุงููุธุงู</div>
            <div class="message-container" style="display: flex; align-items: flex-start; gap: 12px;">
                <div style="flex: 1;">
                    <div class="starfox-cards" id="cards-4qcLSK" style="border-radius: 15px 15px 15px 0; max-width: 80%;">
                        <div class="starfox-card" id="card-y9T5F2" style="border-radius: inherit;">
                            <div class="starfox-card__content" style="padding: 12px 15px;">
                                ${sqlHtml}
                                <p class="starfox-paragraph starfox-paragraph--md" id="paragraph-G1HycM" style="margin: 0;">
                                    ${htmlContent}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
<div class="message-time"></div>
    `;


        // ุฅุถุงูุฉ ูุณุชูุน ุงูุญุฏุซ ููุฒุฑ
        const sqlToggleBtn = messageDiv.querySelector('.sql-toggle-btn');
        const sqlContent = messageDiv.querySelector('.sql-content');
        
        if (sqlToggleBtn && sqlContent) {
            sqlToggleBtn.addEventListener('click', function() {
                const isHidden = sqlContent.style.display === 'none';
                sqlContent.style.display = isHidden ? 'block' : 'none';
                this.querySelector('.btn-text').textContent = isHidden ? 'ุฅุฎูุงุก SQL Query' : 'ุนุฑุถ SQL Query';
                this.classList.toggle('active', isHidden);
            });
        }

        // ุฅุถุงูุฉ ูุณุชูุน ุงูุญุฏุซ ูุฒุฑ ุงููุณุฎ
        const copyButton = messageDiv.querySelector('.copy-btn');
        if (copyButton) {
            copyButton.addEventListener('click', function() {
                copyToClipboard(this);
            });
        }
    }

    messagesGrid.appendChild(messageDiv);
    messageDiv.scrollIntoView({ behavior: 'smooth' });


// ุชุทุจูู ุงูุชูููู ุนูู ุงูุฃููุงุฏ ุฏุงุฎู ุงูุฑุณุงูุฉ
const codeBlocks = messageDiv.querySelectorAll('pre code');
codeBlocks.forEach((block) => {
    hljs.highlightElement(block);
});
}


       // ุชุนุฑูู ุงูุฏุงูุฉ ูู ุงููุทุงู ุงูุนุงู
function copyToClipboard(button) {
    const sqlContent = button.closest('.sql-content');
    if (!sqlContent) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุนูุตุฑ ุงููุทููุจ.');
        return;
    }
    const codeElement = sqlContent.querySelector('code');
    if (!codeElement) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุนูุตุฑ ุงูููุฏ.');
        return;
    }
    const sqlCode = codeElement.textContent;

    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(sqlCode).then(() => {
            // ุชุบููุฑ ุดูู ุงูุฒุฑ ููุฅุดุงุฑุฉ ุฅูู ุงููุฌุงุญ
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check"></i> ุชู ุงููุณุฎ';
            button.classList.add('copied');

            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('copied');
            }, 2000);
        }).catch(err => {
            console.error('ูุดู ุงููุณุฎ:', err);
            alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงููุณุฎ: ' + err);
            // ุชุบููุฑ ุดูู ุงูุฒุฑ ููุฅุดุงุฑุฉ ุฅูู ุงูุฎุทุฃ
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="fas fa-times"></i> ูุดู ุงููุณุฎ';
            button.classList.add('copy-error');

            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('copy-error');
            }, 2000);
        });
    } else {
        // ุงุณุชุฎุฏุงู ุทุฑููุฉ ุจุฏููุฉ ูููุณุฎ
        const textarea = document.createElement('textarea');
        textarea.value = sqlCode;
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
            // ุชุบููุฑ ุดูู ุงูุฒุฑ ููุฅุดุงุฑุฉ ุฅูู ุงููุฌุงุญ
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check"></i> ุชู ุงููุณุฎ';
            button.classList.add('copied');

            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('copied');
            }, 2000);
        } catch (err) {
            console.error('ูุดู ุงููุณุฎ:', err);
            alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงููุณุฎ: ' + err);
            // ุชุบููุฑ ุดูู ุงูุฒุฑ ููุฅุดุงุฑุฉ ุฅูู ุงูุฎุทุฃ
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="fas fa-times"></i> ูุดู ุงููุณุฎ';
            button.classList.add('copy-error');

            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('copy-error');
            }, 2000);
        }
        document.body.removeChild(textarea);
    }
}
        // ุชุญุฏูุซ ุฏุงูุฉ ุฅุฑุณุงู ุงูุตูุช ูุน ุฅุถุงูุฉ ุชุญุฏูุซุงุช ุดุฑูุท ุงูุชูุฏู
        function sendAudio(audioBlob) {
            if (isProcessing) return;
            
            isProcessing = true;
            voiceButton.disabled = true;
            
            const progressBar = document.getElementById('progressBar');
            const progressBarFill = progressBar.querySelector('.progress-bar');
            
            // ุนุฑุถ ุดุฑูุท ุงูุชูุฏู ูุจุฏุก ุงูุชุญุฏูุซ ุงูุชุฏุฑูุฌู
            progressBar.style.display = 'block';
            progressBarFill.style.width = '0%';
            
            // ุจุฏุก ุงูุชุญุฏูุซ ุงูุชุฏุฑูุฌู ููุดุฑูุท
            let progress = 0;
            const progressInterval = setInterval(() => {
                if (progress < 90) {  // ูุชููู ุนูุฏ 90% ุญุชู ูุญุตู ุนูู ุงูุฑุฏ
                    progress += 1;
                    progressBarFill.style.width = `${progress}%`;
                }
            }, 100);

            const formData = new FormData();
            formData.append('audio', audioBlob, 'recording.mp3');

            fetch('process_audio/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-API-Key': String(localStorage.getItem('apiKey'))
                }
            })
            .then(response => response.json())
            .then(data => {
                // ุฅููุงู ุงูุชุญุฏูุซ ุงูุชุฏุฑูุฌู ูุฅููุงู ุงูุดุฑูุท
                clearInterval(progressInterval);
                progressBarFill.style.width = '100%';
                
                if (data.status === 'success') {
                    createMessageElement(data.user);
                    processMarkdownResponse(data.data,data.sql_query);
                } else {
                    processMarkdownResponse(data.message || 'ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุนุฑูู');
                }
                
                // ุฅุฎูุงุก ุดุฑูุท ุงูุชูุฏู ุจุนุฏ ุงูุชูุงู ุงูุนูููุฉ
                setTimeout(() => {
                    progressBar.style.display = 'none';
                    progressBarFill.style.width = '0%';
                }, 1000);
            })
            .catch(error => {
                clearInterval(progressInterval);
                console.error('Error:', error);
                if (!apiInput.value) {
                    processMarkdownResponse('ุนุฐุฑุงูุ ูุฌุจ ุฅุฏุฎุงู ููุชุงุญ API ุงูุฎุงุต ุจู OpenAI ูููุชุงุจุนุฉ');
                } else {
                processMarkdownResponse('ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ูู ูุนุงูุฌุฉ ุทูุจู');
                }
                progressBar.style.display = 'none';
            })
            .finally(() => {
                isProcessing = false;
                voiceButton.disabled = false;
            });
        }

        // ุฏุงูุฉ ุฅุฑุณุงู ุงูุงุณุชุนูุงู ุงููุตู
        function sendQuery(query) {
            
            const progressBar = document.getElementById('progressBar');
            const progressBarFill = progressBar.querySelector('.progress-bar');
            
            // ุนุฑุถ ุดุฑูุท ุงูุชูุฏู ูุจุฏุก ุงูุชุญุฏูุซ ุงูุชุฏุฑูุฌู
            progressBar.style.display = 'block';
            progressBarFill.style.width = '0%';
            
            // ุจุฏุก ุงูุชุญุฏูุซ ุงูุชุฏุฑูุฌู ููุดุฑูุท
            let progress = 0;
            const progressInterval = setInterval(() => {
                if (progress < 90) {  // ูุชููู ุนูุฏ 90% ุญุชู ูุญุตู ุนูู ุงูุฑุฏ
                    progress += 1;
                    progressBarFill.style.width = `${progress}%`;
                }
            }, 100);


            $.ajax({
                url: 'process_query/',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ 
                    query: query, 
                    api_key: localStorage.getItem('apiKey') 
                }),
                success: function(response) {
                     // ุฅููุงู ุงูุชุญุฏูุซ ุงูุชุฏุฑูุฌู ูุฅููุงู ุงูุดุฑูุท
                clearInterval(progressInterval);
                progressBarFill.style.width = '100%';

                    if (response.status === 'success') {
                        processMarkdownResponse(response.data, response.sql_query);
                    } else {
                        processMarkdownResponse(response.message || 'ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุนุฑูู');
                    }
                                    // ุฅุฎูุงุก ุดุฑูุท ุงูุชูุฏู ุจุนุฏ ุงูุชูุงู ุงูุนูููุฉ
                setTimeout(() => {
                    progressBar.style.display = 'none';
                    progressBarFill.style.width = '0%';
                }, 1000);
                },
                error: function(xhr, status, error) {
                    if (!apiInput.value) {
                        processMarkdownResponse('ุนุฐุฑุงูุ ูุฌุจ ุฅุฏุฎุงู ููุชุงุญ API ุงูุฎุงุต ุจู OpenAI ูููุชุงุจุนุฉ');
                    } else {
                        processMarkdownResponse('ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ูู ูุนุงูุฌุฉ ุทูุจู');
                    }
                }
            });
        }

        // ุฏุงูุฉ ุฅูุดุงุก ุฑุณุงูุฉ ุฌุฏูุฏุฉ
        function createMessageElement(text, type = 'user-message', label = 'ุงูุณุคุงู') {
            const emptyState = messagesGrid.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message-bubble ${type}`;

            messageDiv.className = `message-bubble ${type}`;

messageDiv.innerHTML = `
        <div class="message-label">${label}</div>
        
        <div class="message-container" style="display: flex; align-items: flex-start; gap: 12px;">
            <div class="user-avatar" style="width: 45px; height: 45px; border-radius: 50%;  display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-user-circle" style="font-size: 28px; "></i>
            </div>
            <div style="flex: 1;">
                <div class="starfox-cards" id="cards-4qcLSK" style="background: transparent; border-radius: 15px 15px 15px 0; max-width: 80%;">
                    <div class="starfox-card" id="card-y9T5F2" style="border-radius: inherit;">
                        <div class="starfox-card__content" style="padding: 12px 15px;">
                            <p class="starfox-paragraph starfox-paragraph--md" id="paragraph-G1HycM" style="margin: 0;">
                                ${text}
                            </p>
                        </div>
                    </div>
                </div>
                <div class="message-time" style="font-size: 12px; color: #666; margin-top: 4px;">
                    ${new Date().toLocaleTimeString()}
                </div>
            </div>
        </div>
`;

            messagesGrid.appendChild(messageDiv);
            messageDiv.scrollIntoView({ behavior: 'smooth' });

}

    
// ุชุญุฏูุซ ุฏุงูุฉ addMessage
async function addMessage(text) {
    try {
        // ุฅูุดุงุก ุฑุณุงูุฉ ุงููุณุชุฎุฏู
        createMessageElement(text, 'user-message', 'ุงูุณุคุงู');
        
        // ุฅุฑุณุงู ุงูุงุณุชุนูุงู
        await sendQuery(text);
    } catch (error) {
        console.error('Error in addMessage:', error);
        if (!apiInput.value) {
                processMarkdownResponse('ุนุฐุฑุงูุ ูุฌุจ ุฅุฏุฎุงู ููุชุงุญ API ุงูุฎุงุต ุจู OpenAI ูููุชุงุจุนุฉ');
        } else {
            processMarkdownResponse('ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ูู ูุนุงูุฌุฉ ุทูุจู');
        }
    }
}
        
        // ุฏุงูุฉ ุฅููุงู ุงูุชุณุฌูู
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                isRecording = false;
                mediaRecorder.stop();
            }
        }

        // ุชุญุฏูุซ ุฏุงูุฉ ุชุจุฏูู ุญุงูุฉ ุงูุชุณุฌูู
        function toggleRecording() {
            const micIcon = voiceButton.querySelector('i');
            
            if (isProcessing) return;
            
            if (!isRecording) {
                navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        channelCount: 1,
                        sampleRate: 44100,
                        sampleSize: 16
                    } 
                })
                .then(stream => {
                    isRecording = true;
                    voiceButton.style.background = 'linear-gradient(135deg, #c95959 0%, #ff8d8d 100%)';
                    micIcon.style.color = '#fff';

                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                        sendAudio(audioBlob);
                        voiceButton.style.background = 'linear-gradient(135deg, #c95959 0%, #af2929 100%)';
                        micIcon.style.color = '#fff';

                        
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    setTimeout(() => {
                        if (isRecording) {
                            stopRecording();
                        }
                    }, 10000); // ุงูุญุฏ ุงูุฃูุตู ููุชุณุฌูู 10 ุซูุงูู
                })
                .catch(error => {
                    console.error('Error accessing microphone:', error);
                    processMarkdownResponse('ุนุฐุฑุงูุ ูุง ูููู ุงููุตูู ุฅูู ุงููููุฑูููู');
                    isProcessing = false;
                });
            } else {
                stopRecording();
            }
        }

        // ุฅุถุงูุฉ ุฏุงูุฉ ููุญุตูู ุนูู CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // ุชุญุฏูุซ ูุณุชูุนุงุช ุงูุฃุญุฏุงุซ ููุฒุฑ
        voiceButton.addEventListener('touchstart', function(e) {
            e.preventDefault();
            if (!isRecording) {
                toggleRecording();
            }
        });

        voiceButton.addEventListener('touchend', function(e) {
            e.preventDefault();
            if (isRecording) {
                stopRecording();
            }
        });

        // ูุณุชูุนุงุช ุฃุญุฏุงุซ ุฒุฑ ุงูุชุณุฌูู
        voiceButton.addEventListener('click', toggleRecording);

        voiceButton.addEventListener('mousedown', function(e) {
            pressTimer = setTimeout(() => {
                toggleRecording();
            }, 200);
        });

        voiceButton.addEventListener('mouseup', function(e) {
            clearTimeout(pressTimer);
            if (isRecording) {
                stopRecording();
            }
        });

        voiceButton.addEventListener('mouseleave', function(e) {
            clearTimeout(pressTimer);
            if (isRecording) {
                stopRecording();
            }
        });        
</script>



</body>
</html>